# Get the DC
$GetVM = Get-VM |Where State -eq 'Off' | Where-Object -Property Name -Match "DC1"
# Get the state
$VMState = $GetVM | Select-Object -Property State

# Start the DC
if($VMState -eq "Off"){
    Start-VM -Name "DC1"
    Write-Host "$VMName is running" -ForegroundColor Green
}

# Wait for ADWS to come online
Invoke-Command -VMName DC1 -Credential $DomainCred -ScriptBlock {
    Write-Verbose "Waiting for AD Web Services to be in a running state" -Verbose
    $ADWebSvc = Get-Service ADWS | Select-Object *
    while($ADWebSvc.Status -ne 'Running')
            {
            Start-Sleep -Seconds 1
            $ADWebSvc = Get-Service ADWS | Select-Object *
            }
	Write-Host "ADWS is running" -ForegroundColor Black -BackgroundColor Green
	}


# Test if LogonUI is still up
function Test-Connectivity{

    param(
    [parameter(Mandatory = $true)][string[]]$VMName,
    [parameter(Mandatory = $true)]$Creds
    )

    Write-Host "Waiting on LogonUI..." -ForegroundColor Black -BackgroundColor Magenta
    while($LogonUIStat -ne $null){
        $LogonUIStat = Invoke-Command -VMName $VMName -Credential $Creds -ScriptBlock {Get-Process "LogonUI"}
        if($LogonUIStat -eq $null){
            Write-Host "LogonUI is down!" -ForegroundColor Black -BackgroundColor Green
            break
        }
        else{
            Write-Host "LogonUI still up!" -ForegroundColor Black -BackgroundColor Red
            Start-Sleep 2
        }
    }
}